<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fala Alunos - Sistema de Gestão</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-graduation-cap"></i>
                <span>Fala Alunos</span>
            </div>
            <div class="admin-user-info">
                <span class="user-indicator">
                    <i class="fas fa-user-shield"></i>
                    Administrador
                </span>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#dashboard" class="nav-link active" data-section="dashboard">
                        <i class="fas fa-chart-bar"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#organograma" class="nav-link" data-section="organograma">
                        <i class="fas fa-sitemap"></i> Organograma
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#kanban" class="nav-link" data-section="kanban">
                        <i class="fas fa-tasks"></i> Kanban
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#usuarios" class="nav-link" data-section="usuarios">
                        <i class="fas fa-users"></i> Usuários
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#metricas" class="nav-link" data-section="metricas">
                        <i class="fas fa-analytics"></i> Métricas
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#chat" class="nav-link" data-section="chat">
                        <i class="fas fa-comments"></i> Chat
                    </a>
                </li>
            </ul>
            <div class="nav-toggle">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
            <div class="container">
                <h1>Dashboard Principal</h1>
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3>Visão Geral</h3>
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="card-content">
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <span class="stat-number">45%</span>
                                    <span class="stat-label">Taxa de Conclusão</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">16</span>
                                    <span class="stat-label">Projetos Ativos</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">16</span>
                                    <span class="stat-label">Usuários Online</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Gráfico de Performance</h3>
                        </div>
                        <div class="card-content">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Atividades Recentes</h3>
                        </div>
                        <div class="card-content">
                            <div class="activity-list">
                                <div class="activity-item">
                                    <i class="fas fa-user-plus"></i>
                                    <span>Novo usuário cadastrado</span>
                                    <small>2 min atrás</small>
                                </div>
                                <div class="activity-item">
                                    <i class="fas fa-check"></i>
                                    <span>Tarefa concluída no Kanban</span>
                                    <small>5 min atrás</small>
                                </div>
                                <div class="activity-item">
                                    <i class="fas fa-edit"></i>
                                    <span>Organograma atualizado</span>
                                    <small>10 min atrás</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Organograma Section -->
        <section id="organograma" class="section">
            <div class="container">
                <h1>Organograma</h1>
                
                <!-- Controles do Organograma -->
                <div class="organograma-controls">
                    <button class="btn btn-primary" onclick="openAddPositionModal()">
                        <i class="fas fa-plus"></i> Adicionar Cargo
                    </button>
                    <button class="btn btn-secondary" onclick="resetOrganogram()">
                        <i class="fas fa-refresh"></i> Resetar Organograma
                    </button>
                    <div class="view-controls">
                        <label>
                            <input type="checkbox" id="showConnectionLines" checked onchange="toggleConnectionLines()">
                            Mostrar Linhas de Conexão
                        </label>
                    </div>
                </div>

                <!-- Container do Organograma -->
                <div class="organograma-container" id="organogramaContainer">
                    <div class="empty-organogram">
                        <i class="fas fa-sitemap"></i>
                        <h3>Organograma Vazio</h3>
                        <p>Comece adicionando o primeiro cargo da sua organização</p>
                        <button class="btn btn-primary" onclick="openAddPositionModal()">
                            <i class="fas fa-plus"></i> Adicionar Primeiro Cargo
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Kanban Section -->
        <section id="kanban" class="section">
            <div class="container">
                <h1>Kanban Board</h1>
                <div class="kanban-board">
                    <div class="kanban-column" data-status="todo">
                        <div class="column-header">
                            <h3>A Fazer</h3>
                            <span class="task-count">3</span>
                        </div>
                        <div class="column-content" id="todo-column">
                            <div class="kanban-card" draggable="true">
                                <div class="card-priority high"></div>
                                <div class="card-header">
                                    <h4>Implementar Dashboard</h4>
                                    <div class="card-actions">
                                        <button class="btn-action complete" onclick="completeTask(this)" title="Marcar como concluída">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn-action edit" onclick="editTask(this)" title="Editar tarefa">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-action delete" onclick="deleteTask(this)" title="Excluir tarefa">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <p>Criar interface principal do sistema</p>
                                <div class="card-footer">
                                    <span class="card-date">15/12/2024</span>
                                    <div class="card-avatar">JD</div>
                                </div>
                            </div>
                            <div class="kanban-card" draggable="true">
                                <div class="card-priority medium"></div>
                                <div class="card-header">
                                    <h4>Revisar Documentação</h4>
                                    <div class="card-actions">
                                        <button class="btn-action complete" onclick="completeTask(this)" title="Marcar como concluída">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn-action edit" onclick="editTask(this)" title="Editar tarefa">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-action delete" onclick="deleteTask(this)" title="Excluir tarefa">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <p>Atualizar manuais do usuário</p>
                                <div class="card-footer">
                                    <span class="card-date">16/12/2024</span>
                                    <div class="card-avatar">MS</div>
                                </div>
                            </div>
                            <div class="kanban-card" draggable="true">
                                <div class="card-priority low"></div>
                                <div class="card-header">
                                    <h4>Teste de Performance</h4>
                                    <div class="card-actions">
                                        <button class="btn-action complete" onclick="completeTask(this)" title="Marcar como concluída">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn-action edit" onclick="editTask(this)" title="Editar tarefa">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-action delete" onclick="deleteTask(this)" title="Excluir tarefa">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <p>Verificar velocidade do sistema</p>
                                <div class="card-footer">
                                    <span class="card-date">17/12/2024</span>
                                    <div class="card-avatar">AB</div>
                                </div>
                            </div>
                        </div>
                        <button class="add-task-btn" onclick="addTask('todo')">
                            <i class="fas fa-plus"></i> Adicionar Tarefa
                        </button>
                    </div>

                    <div class="kanban-column" data-status="doing">
                        <div class="column-header">
                            <h3>Em Progresso</h3>
                            <span class="task-count">2</span>
                        </div>
                        <div class="column-content" id="doing-column">
                            <div class="kanban-card" draggable="true">
                                <div class="card-priority high"></div>
                                <div class="card-header">
                                    <h4>Desenvolver API</h4>
                                    <div class="card-actions">
                                        <button class="btn-action complete" onclick="completeTask(this)" title="Marcar como concluída">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn-action edit" onclick="editTask(this)" title="Editar tarefa">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-action delete" onclick="deleteTask(this)" title="Excluir tarefa">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <p>Criar endpoints para integração</p>
                                <div class="card-footer">
                                    <span class="card-date">14/12/2024</span>
                                    <div class="card-avatar">LT</div>
                                </div>
                            </div>
                            <div class="kanban-card" draggable="true">
                                <div class="card-priority medium"></div>
                                <div class="card-header">
                                    <h4>Design UI/UX</h4>
                                    <div class="card-actions">
                                        <button class="btn-action complete" onclick="completeTask(this)" title="Marcar como concluída">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn-action edit" onclick="editTask(this)" title="Editar tarefa">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-action delete" onclick="deleteTask(this)" title="Excluir tarefa">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <p>Melhorar interface do usuário</p>
                                <div class="card-footer">
                                    <span class="card-date">13/12/2024</span>
                                    <div class="card-avatar">RF</div>
                                </div>
                            </div>
                        </div>
                        <button class="add-task-btn" onclick="addTask('doing')">
                            <i class="fas fa-plus"></i> Adicionar Tarefa
                        </button>
                    </div>

                    <div class="kanban-column" data-status="review">
                        <div class="column-header">
                            <h3>Em Revisão</h3>
                            <span class="task-count">1</span>
                        </div>
                        <div class="column-content" id="review-column">
                            <div class="kanban-card" draggable="true">
                                <div class="card-priority medium"></div>
                                <div class="card-header">
                                    <h4>Validar Funcionalidades</h4>
                                    <div class="card-actions">
                                        <button class="btn-action complete" onclick="completeTask(this)" title="Marcar como concluída">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn-action edit" onclick="editTask(this)" title="Editar tarefa">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-action delete" onclick="deleteTask(this)" title="Excluir tarefa">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <p>Testar todas as features implementadas</p>
                                <div class="card-footer">
                                    <span class="card-date">12/12/2024</span>
                                    <div class="card-avatar">CM</div>
                                </div>
                            </div>
                        </div>
                        <button class="add-task-btn" onclick="addTask('review')">
                            <i class="fas fa-plus"></i> Adicionar Tarefa
                        </button>
                    </div>

                    <div class="kanban-column" data-status="done">
                        <div class="column-header">
                            <h3>Concluído</h3>
                            <span class="task-count">4</span>
                        </div>
                        <div class="column-content" id="done-column">
                            <div class="kanban-card" draggable="true">
                                <div class="card-priority high"></div>
                                <div class="card-header">
                                    <h4>Setup Inicial</h4>
                                    <div class="card-actions">
                                        <button class="btn-action reopen" onclick="reopenTask(this)" title="Reabrir tarefa">
                                            <i class="fas fa-undo"></i>
                                        </button>
                                        <button class="btn-action edit" onclick="editTask(this)" title="Editar tarefa">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-action delete" onclick="deleteTask(this)" title="Excluir tarefa">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <p>Configuração do ambiente de desenvolvimento</p>
                                <div class="card-footer">
                                    <span class="card-date">10/12/2024</span>
                                    <div class="card-avatar">LT</div>
                                </div>
                            </div>
                            <div class="kanban-card" draggable="true">
                                <div class="card-priority medium"></div>
                                <div class="card-header">
                                    <h4>Banco de Dados</h4>
                                    <div class="card-actions">
                                        <button class="btn-action reopen" onclick="reopenTask(this)" title="Reabrir tarefa">
                                            <i class="fas fa-undo"></i>
                                        </button>
                                        <button class="btn-action edit" onclick="editTask(this)" title="Editar tarefa">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-action delete" onclick="deleteTask(this)" title="Excluir tarefa">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <p>Estrutura e modelagem dos dados</p>
                                <div class="card-footer">
                                    <span class="card-date">11/12/2024</span>
                                    <div class="card-avatar">DB</div>
                                </div>
                            </div>
                        </div>
                        <button class="add-task-btn" onclick="addTask('done')">
                            <i class="fas fa-plus"></i> Adicionar Tarefa
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Usuários Section -->
        <section id="usuarios" class="section">
            <div class="container">
                <h1>Gestão de Usuários</h1>
                <div class="users-header">
                    <button class="btn btn-primary" onclick="openUserModal()">
                        <i class="fas fa-user-plus"></i> Adicionar Usuário
                    </button>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Buscar usuários..." id="userSearch">
                    </div>
                </div>
                
                <div class="users-grid">
                    <div class="user-card">
                        <div class="user-avatar">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div class="user-info">
                            <h4>Lucas Toledo</h4>
                            <span class="user-role director">Diretor</span>
                            <p>lucas.toledo@falaalunos.com</p>
                        </div>
                        <div class="user-actions">
                            <button class="btn-icon" onclick="editUser(1)">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="deleteUser(1)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <div class="user-card">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-info">
                            <h4>Maria Silva</h4>
                            <span class="user-role coordinator">Coordenadora</span>
                            <p>maria.silva@falaalunos.com</p>
                        </div>
                        <div class="user-actions">
                            <button class="btn-icon" onclick="editUser(2)">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="deleteUser(2)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <div class="user-card">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-info">
                            <h4>João Santos</h4>
                            <span class="user-role teacher">Professor</span>
                            <p>joao.santos@falaalunos.com</p>
                        </div>
                        <div class="user-actions">
                            <button class="btn-icon" onclick="editUser(3)">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="deleteUser(3)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <div class="user-card">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-info">
                            <h4>Ana Costa</h4>
                            <span class="user-role teacher">Professora</span>
                            <p>ana.costa@falaalunos.com</p>
                        </div>
                        <div class="user-actions">
                            <button class="btn-icon" onclick="editUser(4)">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="deleteUser(4)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Métricas Section -->
        <section id="metricas" class="section">
            <div class="container">
                <h1>Métricas e Relatórios</h1>
                <div class="metrics-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3>Gráfico de Barras - Performance por Período</h3>
                        </div>
                        <div class="card-content">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Estatísticas Principais</h3>
                        </div>
                        <div class="card-content">
                            <div class="metrics-stats">
                                <div class="metric-item">
                                    <div class="metric-circle">
                                        <span>45%</span>
                                    </div>
                                    <p>Taxa de Conclusão</p>
                                </div>
                                <div class="metric-bars">
                                    <div class="metric-bar">
                                        <span>Projetos Ativos</span>
                                        <div class="bar-container">
                                            <div class="bar" style="width: 80%"></div>
                                        </div>
                                        <span>16</span>
                                    </div>
                                    <div class="metric-bar">
                                        <span>Usuários Online</span>
                                        <div class="bar-container">
                                            <div class="bar" style="width: 60%"></div>
                                        </div>
                                        <span>16</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Gráfico de Linhas - Evolução Temporal</h3>
                        </div>
                        <div class="card-content">
                            <canvas id="lineChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Comparativo por Categoria</h3>
                        </div>
                        <div class="card-content">
                            <canvas id="comparisonChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Chat Section -->
        <section id="chat" class="section">
            <div class="container">
                <h1>Central de Atendimento</h1>
                
                <!-- Chat Header com Estatísticas -->
                <div class="chat-header">
                    <div class="chat-stats">
                        <div class="stat-card">
                            <i class="fas fa-clock"></i>
                            <div>
                                <span class="stat-number">2 min</span>
                                <span class="stat-label">Tempo Médio de Resposta</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-users"></i>
                            <div>
                                <span class="stat-number">3</span>
                                <span class="stat-label">Coordenadores Online</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-check-circle"></i>
                            <div>
                                <span class="stat-number">98%</span>
                                <span class="stat-label">Satisfação</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-actions">
                        <button class="btn btn-primary" onclick="openNewChatModal()">
                            <i class="fas fa-plus"></i> Nova Conversa
                        </button>
                        <button class="btn btn-secondary" onclick="openSuggestionsModal()">
                            <i class="fas fa-lightbulb"></i> Enviar Sugestão
                        </button>
                    </div>
                </div>

                <!-- Dicas de Navegação -->
                <div style="background: rgba(102, 126, 234, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div style="display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
                            <span><kbd>Ctrl+↑↓</kbd> Navegar conversas</span>
                            <span><kbd>Ctrl+Home/End</kbd> Início/Fim mensagens</span>
                            <span><kbd>Page ↑↓</kbd> Scroll mensagens</span>
                        </div>
                        <small style="color: #6c757d;">Dicas de navegação</small>
                    </div>
                </div>

                <!-- Chat Container -->
                <div class="chat-container">
                    <!-- Lista de Conversas -->
                    <div class="chat-sidebar">
                        <div class="chat-sidebar-header">
                            <h3>Conversas</h3>
                            <div class="chat-filter">
                                <select id="chatFilter">
                                    <option value="all">Todas</option>
                                    <option value="academic">Acadêmicas</option>
                                    <option value="administrative">Administrativas</option>
                                    <option value="suggestions">Sugestões</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="chat-list" id="chatList">
                            <!-- Os chats serão carregados dinamicamente pelo JavaScript -->
                        </div>
                    </div>

                    <!-- Área de Chat Principal -->
                    <div class="chat-main" id="adminChatSection">
                        <div class="chat-main-header">
                            <div class="chat-contact-info">
                                <div class="contact-avatar">
                                    <i class="fas fa-comments"></i>
                                </div>
                                <div class="contact-details">
                                    <h4>Selecione um chat</h4>
                                    <span class="contact-status">
                                        <i class="fas fa-circle"></i> Aguardando seleção
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="chat-messages" id="chatMessages">
                            <div class="message-date">Bem-vindo ao sistema de chat</div>
                            <div class="message received">
                                <div class="message-avatar">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div class="message-content">
                                    <div class="message-bubble">
                                        Olá! Selecione uma conversa na barra lateral para começar a conversar.
                                    </div>
                                    <div class="message-time">Agora</div>
                                </div>
                            </div>
                        </div>

                        <div class="chat-input-container">
                            <div class="chat-input">
                                <input type="text" id="messageInput" placeholder="Digite sua mensagem..." onkeypress="handleEnterKey(event)">
                                <button class="btn-icon" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal para adicionar/editar usuário -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Adicionar Usuário</h3>
                <span class="close" onclick="closeUserModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="form-group">
                        <label for="userName">Nome:</label>
                        <input type="text" id="userName" required>
                    </div>
                    <div class="form-group">
                        <label for="userEmail">Email:</label>
                        <input type="email" id="userEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="userRole">Cargo:</label>
                        <select id="userRole" required>
                            <option value="">Selecione um cargo</option>
                            <option value="director">Diretor</option>
                            <option value="coordinator">Coordenador</option>
                            <option value="teacher">Professor</option>
                            <option value="student">Aluno</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para adicionar tarefa -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Adicionar Nova Tarefa</h3>
                <span class="close" onclick="closeTaskModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <div class="form-group">
                        <label for="taskTitle">Título:</label>
                        <input type="text" id="taskTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="taskDescription">Descrição:</label>
                        <textarea id="taskDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="taskPriority">Prioridade:</label>
                        <select id="taskPriority" required>
                            <option value="low">Baixa</option>
                            <option value="medium">Média</option>
                            <option value="high">Alta</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskDate">Data:</label>
                        <input type="date" id="taskDate" required>
                    </div>
                    <div class="form-group">
                        <label for="taskAssignee">Responsável:</label>
                        <input type="text" id="taskAssignee" placeholder="Iniciais" maxlength="2" required>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Adicionar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para Nova Conversa -->
    <div id="newChatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Iniciar Nova Conversa</h3>
                <span class="close" onclick="closeNewChatModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="newChatForm">
                    <div class="form-group">
                        <label for="chatCategory">Categoria do Atendimento:</label>
                        <select id="chatCategory" required>
                            <option value="">Selecione uma categoria</option>
                            <option value="academic">Suporte Acadêmico</option>
                            <option value="administrative">Processos Administrativos</option>
                            <option value="financial">Questões Financeiras</option>
                            <option value="technical">Suporte Técnico</option>
                            <option value="general">Informações Gerais</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="chatSubject">Assunto:</label>
                        <input type="text" id="chatSubject" placeholder="Descreva brevemente sua dúvida" required>
                    </div>
                    <div class="form-group">
                        <label for="chatMessage">Mensagem Inicial:</label>
                        <textarea id="chatMessage" rows="4" placeholder="Descreva sua dúvida ou solicitação em detalhes..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="chatPriority">Prioridade:</label>
                        <select id="chatPriority" required>
                            <option value="low">Baixa - Não é urgente</option>
                            <option value="medium" selected>Média - Preciso de resposta em algumas horas</option>
                            <option value="high">Alta - É urgente</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeNewChatModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Iniciar Conversa</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para Sugestões -->
    <div id="suggestionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Enviar Sugestão</h3>
                <span class="close" onclick="closeSuggestionsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="suggestionsForm">
                    <div class="form-group">
                        <label for="suggestionType">Tipo de Sugestão:</label>
                        <select id="suggestionType" required>
                            <option value="">Selecione o tipo</option>
                            <option value="system">Melhoria no Sistema</option>
                            <option value="process">Melhoria em Processos</option>
                            <option value="service">Melhoria no Atendimento</option>
                            <option value="feature">Nova Funcionalidade</option>
                            <option value="other">Outros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="suggestionTitle">Título da Sugestão:</label>
                        <input type="text" id="suggestionTitle" placeholder="Resuma sua sugestão em poucas palavras" required>
                    </div>
                    <div class="form-group">
                        <label for="suggestionDescription">Descrição Detalhada:</label>
                        <textarea id="suggestionDescription" rows="5" placeholder="Descreva sua sugestão em detalhes. Como isso pode melhorar a experiência dos alunos?" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="suggestionBenefit">Benefício Esperado:</label>
                        <textarea id="suggestionBenefit" rows="3" placeholder="Que benefícios essa sugestão traria para os alunos e a instituição?"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeSuggestionsModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Enviar Sugestão</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para Avaliação -->
    <div id="ratingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Avaliar Atendimento</h3>
                <span class="close" onclick="closeRatingModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="ratingForm">
                    <div class="form-group">
                        <label>Como você avalia o atendimento recebido?</label>
                        <div class="rating-stars">
                            <i class="fas fa-star" data-rating="1"></i>
                            <i class="fas fa-star" data-rating="2"></i>
                            <i class="fas fa-star" data-rating="3"></i>
                            <i class="fas fa-star" data-rating="4"></i>
                            <i class="fas fa-star" data-rating="5"></i>
                        </div>
                        <input type="hidden" id="ratingValue" required>
                    </div>
                    <div class="form-group">
                        <label for="ratingComment">Comentário (opcional):</label>
                        <textarea id="ratingComment" rows="3" placeholder="Conte-nos mais sobre sua experiência..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeRatingModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Enviar Avaliação</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Tarefa -->
    <div id="editTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Tarefa</h3>
                <span class="close" onclick="closeEditTaskModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <div class="form-group">
                        <label for="editTaskTitle">Título:</label>
                        <input type="text" id="editTaskTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="editTaskDescription">Descrição:</label>
                        <textarea id="editTaskDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editTaskPriority">Prioridade:</label>
                        <select id="editTaskPriority" required>
                            <option value="low">Baixa</option>
                            <option value="medium">Média</option>
                            <option value="high">Alta</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editTaskDate">Data:</label>
                        <input type="date" id="editTaskDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editTaskAssignee">Responsável:</label>
                        <input type="text" id="editTaskAssignee" placeholder="Iniciais" maxlength="2" required>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditTaskModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Posição do Organograma -->
    <div id="positionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="positionModalTitle">Adicionar Cargo</h3>
                <span class="close" onclick="closePositionModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="positionForm">
                    <div class="form-group">
                        <label for="positionName">Nome da Pessoa:</label>
                        <input type="text" id="positionName" required placeholder="Alunos">
                    </div>
                    <div class="form-group">
                        <label for="positionTitle">Cargo/Título:</label>
                        <input type="text" id="positionTitle" required placeholder="Ex: Diretor, Coordenador, Professor">
                    </div>
                    <div class="form-group">
                        <label for="positionDepartment">Departamento/Setor:</label>
                        <input type="text" id="positionDepartment" placeholder="Ex: Administrativo, Acadêmico">
                    </div>
                    <div class="form-group">
                        <label for="positionEmail">Email:</label>
                        <input type="email" id="positionEmail" placeholder="email@exemplo.com">
                    </div>
                    <div class="form-group">
                        <label for="positionPhone">Telefone:</label>
                        <input type="tel" id="positionPhone" placeholder="(11) 99999-9999">
                    </div>
                    <div class="form-group">
                        <label for="positionSuperior">Cargo Superior:</label>
                        <select id="positionSuperior">
                            <option value="">Nenhum (Cargo mais alto)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="positionLevel">Nível Hierárquico:</label>
                        <select id="positionLevel" required>
                            <option value="executive">Executivo</option>
                            <option value="management">Gerência</option>
                            <option value="coordination">Coordenação</option>
                            <option value="operation">Operacional</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="positionIcon">Ícone:</label>
                        <select id="positionIcon">
                            <option value="fa-user-tie">👔 Executivo</option>
                            <option value="fa-user-graduate">🎓 Acadêmico</option>
                            <option value="fa-user-cog">⚙️ Administrativo</option>
                            <option value="fa-user">👤 Geral</option>
                            <option value="fa-chalkboard-teacher">👨‍🏫 Professor</option>
                            <option value="fa-user-shield">🛡️ Segurança</option>
                            <option value="fa-user-md">👨‍⚕️ Saúde</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closePositionModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Cargo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes da Posição -->
    <div id="positionDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detalhes do Cargo</h3>
                <span class="close" onclick="closePositionDetailsModal()">&times;</span>
            </div>
            <div class="modal-body" id="positionDetailsContent">
                <!-- Conteúdo será preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Script do Chat Manager (deve vir antes do script principal) -->
    <script src="script.js"></script>
    <script src="shared-chat.js"></script>
    
    <script>
    // Variáveis globais
    let currentSection = 'dashboard';
    let adminChatInitialized = false;
    
    // ========== VARIÁVEIS DO ORGANOGRAMA ==========
    let organizationalChart = [];
    let currentEditingPosition = null;

    // ========== INICIALIZAÇÃO PRINCIPAL ==========
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Iniciando sistema administrativo...');
        
        // Verificar autenticação
        if (!validateAdminAuth()) return;

        // Inicializar componentes básicos
        initializeBasicComponents();
        
        // Inicializar chat administrativo
        initializeAdminChatSystem();
        
        console.log('✅ Sistema administrativo inicializado com sucesso');
        
        // Event listener para formulário de posição
        const positionForm = document.getElementById('positionForm');
        if (positionForm) {
            positionForm.addEventListener('submit', function(e) {
                e.preventDefault();
                savePosition();
            });
        }
    });

    // Validar autenticação administrativa
    function validateAdminAuth() {
        const userProfile = sessionStorage.getItem('userProfile');
        const adminCredentials = sessionStorage.getItem('adminCredentials');
        
        if (userProfile !== 'admin' || adminCredentials !== 'validated') {
            sessionStorage.removeItem('userProfile');
            sessionStorage.removeItem('adminCredentials');
            sessionStorage.removeItem('loginTime');
            window.location.href = 'login.html';
            return false;
        }
        return true;
    }

    // Inicializar componentes básicos
    function initializeBasicComponents() {
        initializeNavigation();
        initializeCharts();
        initializeDragAndDrop();
        initializeSearch();
        initializeModals();
        updateTaskCounts();
        setupNewChatForm();
        initializeOrganogram();
    }

    // ========== SISTEMA DE CHAT ADMINISTRATIVO ==========
    function initializeAdminChatSystem() {
        if (adminChatInitialized) {
            console.log('⚠️ Chat administrativo já foi inicializado');
            return;
        }

        console.log('📱 Inicializando sistema de chat administrativo...');
        
        // Aguardar RealTimeChatManager estar disponível
        const checkChatManager = setInterval(() => {
            if (window.RealTimeChatManager) {
                clearInterval(checkChatManager);
                
                // Certificar que o sessionStorage tem o tipo correto
                sessionStorage.setItem('userProfile', 'admin');
                
                // Inicializar o RealTimeChatManager
                window.chatManager = new RealTimeChatManager();
                
                // Adicionar listener para novas mensagens
                window.chatManager.addMessageListener((message) => {
                    console.log('Nova mensagem recebida no admin:', message);
                    addMessageToAdminInterface(message);
                });
                
                console.log('✅ Chat Manager do administrador inicializado com sucesso');
                
                // Carregar chats após inicialização
                setTimeout(() => {
                    loadAdminChats();
                }, 1000);
                
                adminChatInitialized = true;
            }
        }, 100);
    }

    // Carregar chats administrativos
    async function loadAdminChats() {
        if (!window.chatManager) {
            console.log('⚠️ Chat Manager não disponível ainda');
            return;
        }

        try {
            console.log('📊 Carregando chats administrativos...');
            const chats = await window.chatManager.loadChats();
            console.log('Chats carregados:', chats);
            
            updateAdminChatList(chats);
            
        } catch (error) {
            console.error('❌ Erro ao carregar chats:', error);
        }
    }

    // Atualizar lista de chats na interface administrativa
    function updateAdminChatList(chats) {
        const chatList = document.getElementById('chatList');
        if (!chatList) return;

        // Limpar lista atual
        chatList.innerHTML = '';
        
        // Adicionar chats dinâmicos
        chats.forEach(chat => {
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            chatItem.setAttribute('data-chat-id', chat.id);
            
            const priorityIcon = chat.priority === 'high' ? '🔴' : chat.priority === 'medium' ? '🟡' : '🟢';
            const categoryIcon = getCategoryIcon(chat.category);
            
            chatItem.innerHTML = `
                <div class="chat-avatar">
                    <i class="fas ${categoryIcon}"></i>
                </div>
                <div class="chat-info">
                    <h4>${chat.title} ${priorityIcon}</h4>
                    <p>${chat.description || 'Sem descrição'}</p>
                    <small>${formatTimeAgo(chat.createdAt)} - por ${chat.createdBy}</small>
                </div>
                <div class="chat-status online"></div>
            `;
            
            chatItem.addEventListener('click', () => {
                // Remover active de outros chats
                chatList.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Adicionar active ao chat clicado
                chatItem.classList.add('active');
                
                // Abrir chat
                openAdminChat(chat);
            });
            
            chatList.appendChild(chatItem);
        });
        
        console.log(`${chats.length} chats carregados na interface administrativa`);
    }

    // Abrir chat administrativo
    function openAdminChat(chat) {
        console.log('Abrindo chat administrativo:', chat);
        
        // Atualizar header do chat
        const contactInfo = document.querySelector('.chat-contact-info');
        if (contactInfo) {
            contactInfo.innerHTML = `
                <div class="contact-avatar">
                    <i class="fas ${getCategoryIcon(chat.category)}"></i>
                </div>
                <div class="contact-details">
                    <h4>${chat.title}</h4>
                    <span class="contact-status">
                        <i class="fas fa-circle online"></i> Chat criado por ${chat.createdBy} - ${chat.priority} prioridade
                    </span>
                </div>
            `;
        }
        
        // Limpar mensagens e carregar as específicas do chat
        const messagesContainer = document.getElementById('chatMessages');
        if (messagesContainer) {
            messagesContainer.innerHTML = `
                <div class="message-date">Chat: ${chat.title}</div>
                <div class="message received">
                    <div class="message-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-bubble">
                            ${chat.description || 'Chat iniciado'}
                        </div>
                        <div class="message-time">${formatTimeAgo(chat.createdAt)}</div>
                    </div>
                </div>
            `;
        }
        
        // Atualizar categoria atual do chat manager
        if (window.chatManager) {
            window.chatManager.setCurrentCategory && window.chatManager.setCurrentCategory(chat.category);
        }
    }

    // Adicionar mensagem à interface administrativa
    function addMessageToAdminInterface(messageData) {
        console.log('📨 Adicionando mensagem à interface administrativa:', messageData);
        
        const messagesContainer = document.getElementById('chatMessages');
        if (!messagesContainer) {
            console.error('❌ Container de mensagens não encontrado');
            return;
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${messageData.senderType === 'admin' ? 'sent' : 'received'}`;
        
        const messageContent = messageData.content || messageData.message || messageData.text || 'Mensagem vazia';
        
        const time = new Date(messageData.timestamp || Date.now()).toLocaleTimeString('pt-BR', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        if (messageData.senderType === 'admin') {
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="message-bubble">
                        ${messageContent}
                    </div>
                    <div class="message-time">${time}</div>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        ${messageContent}
                    </div>
                    <div class="message-time">${time}</div>
                </div>
            `;
        }
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        console.log('✅ Mensagem adicionada à interface administrativa');
    }

    // Configurar formulário de novo chat
    function setupNewChatForm() {
        const newChatForm = document.getElementById('newChatForm');
        if (newChatForm) {
            newChatForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!window.chatManager) {
                    alert('Sistema de chat não está conectado');
                    return;
                }

                const chatData = {
                    title: document.getElementById('chatSubject').value,
                    category: document.getElementById('chatCategory').value,
                    priority: document.getElementById('chatPriority').value,
                    description: document.getElementById('chatMessage').value
                };

                try {
                    const newChat = await window.chatManager.createChat(chatData);
                    if (newChat) {
                        closeNewChatModal();
                        showAdminNotification('Chat criado com sucesso!', 'success');
                        await loadAdminChats();
                    }
                } catch (error) {
                    console.error('Erro ao criar chat:', error);
                    alert('Erro ao criar chat. Tente novamente.');
                }
            });
        }
    }

    // Enviar mensagem
    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        if (!messageInput || !window.chatManager) {
            console.error('Input de mensagem ou chat manager não disponível');
            return;
        }
        
        const content = messageInput.value.trim();
        if (!content) return;
        
        try {
            // Enviar mensagem através do chat manager
            const success = window.chatManager.sendMessage('general', content);
            
            if (success) {
                messageInput.value = '';
                console.log('Mensagem enviada pelo admin:', content);
                showAdminNotification('Mensagem enviada!', 'success');
            } else {
                showAdminNotification('Erro ao enviar mensagem', 'error');
            }
        } catch (error) {
            console.error('Erro ao enviar mensagem:', error);
            showAdminNotification('Erro ao enviar mensagem', 'error');
        }
    }
    
    // Função para lidar com Enter no input
    function handleEnterKey(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }

    // Gerenciar modais de chat
    function openNewChatModal() {
        document.getElementById('newChatModal').style.display = 'block';
    }

    function closeNewChatModal() {
        document.getElementById('newChatModal').style.display = 'none';
        document.getElementById('newChatForm').reset();
    }

    // Função para mostrar notificação no admin
    function showAdminNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `admin-notification ${type}`;
        notification.textContent = message;
        
        // Estilos inline para a notificação
        Object.assign(notification.style, {
            position: 'fixed',
            top: '20px',
            right: '20px',
            background: type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff',
            color: 'white',
            padding: '12px 20px',
            borderRadius: '6px',
            fontWeight: '500',
            zIndex: '10000',
            boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
            transition: 'all 0.3s ease',
            transform: 'translateX(100%)',
            opacity: '0'
        });
        
        document.body.appendChild(notification);
        
        // Animação de entrada
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
            notification.style.opacity = '1';
        }, 100);
        
        // Remover após 3 segundos
        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // Funções auxiliares
    function getCategoryIcon(category) {
        const icons = {
            academic: 'fa-graduation-cap',
            administrative: 'fa-file-alt',
            financial: 'fa-dollar-sign',
            technical: 'fa-cog',
            general: 'fa-comments'
        };
        return icons[category] || 'fa-comments';
    }

    function formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffInMinutes = Math.floor((now - date) / (1000 * 60));
        
        if (diffInMinutes < 1) return 'Agora';
        if (diffInMinutes < 60) return `${diffInMinutes} min atrás`;
        if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)} horas atrás`;
        return `${Math.floor(diffInMinutes / 1440)} dias atrás`;
    }

    // Carregar chats quando a seção de chat for acessada
    document.addEventListener('DOMContentLoaded', function() {
        const chatNavLink = document.querySelector('[data-section="chat"]');
        if (chatNavLink) {
            chatNavLink.addEventListener('click', function() {
                setTimeout(() => {
                    loadAdminChats();
                }, 100);
            });
        }
    });

    // Listener para novos chats criados
    window.addEventListener('newChatCreated', function(event) {
        const chat = event.detail;
        console.log('Novo chat detectado no admin:', chat);
        loadAdminChats();
    });

    // ========== FUNÇÕES DO ORGANOGRAMA ==========
    
    // Inicializar organograma
    function initializeOrganogram() {
        console.log('🏢 Inicializando organograma...');
        const savedChart = localStorage.getItem('organizationalChart');
        if (savedChart) {
            try {
                organizationalChart = JSON.parse(savedChart);
                renderOrganogram();
            } catch (error) {
                console.error('Erro ao carregar organograma salvo:', error);
                showEmptyOrganogram();
            }
        } else {
            showEmptyOrganogram();
        }
    }

    // Mostrar organograma vazio
    function showEmptyOrganogram() {
        const container = document.getElementById('organogramaContainer');
        if (!container) return;
        
        container.innerHTML = `
            <div class="empty-organogram">
                <i class="fas fa-sitemap"></i>
                <h3>Organograma Vazio</h3>
                <p>Comece adicionando o primeiro cargo da sua organização</p>
                <button class="btn btn-primary" onclick="openAddPositionModal()">
                    <i class="fas fa-plus"></i> Adicionar Primeiro Cargo
                </button>
            </div>
        `;
    }

    // Abrir modal para adicionar posição
    function openAddPositionModal(parentId = null) {
        currentEditingPosition = null;
        document.getElementById('positionModalTitle').textContent = 'Adicionar Cargo';
        document.getElementById('positionForm').reset();
        populateSuperiorDropdown(parentId);
        if (parentId) {
            document.getElementById('positionSuperior').value = parentId;
        }
        document.getElementById('positionModal').style.display = 'block';
    }

    // Fechar modal de posição
    function closePositionModal() {
        document.getElementById('positionModal').style.display = 'none';
        currentEditingPosition = null;
    }

    // Preencher dropdown de superiores
    function populateSuperiorDropdown(excludeId = null) {
        const select = document.getElementById('positionSuperior');
        if (!select) return;
        
        select.innerHTML = '<option value="">Nenhum (Cargo mais alto)</option>';
        organizationalChart.forEach(position => {
            if (position.id !== excludeId && position.id !== currentEditingPosition) {
                const option = document.createElement('option');
                option.value = position.id;
                option.textContent = `${position.name} - ${position.title}`;
                select.appendChild(option);
            }
        });
    }

    // Salvar posição
    function savePosition() {
        const position = {
            id: currentEditingPosition || generateId(),
            name: document.getElementById('positionName').value,
            title: document.getElementById('positionTitle').value,
            department: document.getElementById('positionDepartment').value,
            email: document.getElementById('positionEmail').value,
            phone: document.getElementById('positionPhone').value,
            superiorId: document.getElementById('positionSuperior').value || null,
            level: document.getElementById('positionLevel').value,
            icon: document.getElementById('positionIcon').value,
            createdAt: currentEditingPosition ? 
                organizationalChart.find(p => p.id === currentEditingPosition)?.createdAt || new Date().toISOString() : 
                new Date().toISOString()
        };
        
        if (currentEditingPosition) {
            const index = organizationalChart.findIndex(p => p.id === currentEditingPosition);
            if (index !== -1) {
                organizationalChart[index] = position;
                showAdminNotification('Cargo atualizado com sucesso!', 'success');
            }
        } else {
            organizationalChart.push(position);
            showAdminNotification('Cargo adicionado com sucesso!', 'success');
        }
        
        localStorage.setItem('organizationalChart', JSON.stringify(organizationalChart));
        renderOrganogram();
        closePositionModal();
    }

    // Renderizar organograma
    function renderOrganogram() {
        if (organizationalChart.length === 0) {
            showEmptyOrganogram();
            return;
        }
        
        const container = document.getElementById('organogramaContainer');
        if (!container) return;
        
        const hierarchy = buildHierarchy();
        const orgChart = document.createElement('div');
        orgChart.className = 'org-chart';
        
        hierarchy.forEach((level) => {
            const levelDiv = document.createElement('div');
            levelDiv.className = 'org-level';
            
            level.forEach(position => {
                const nodeDiv = createPositionNode(position);
                levelDiv.appendChild(nodeDiv);
            });
            
            orgChart.appendChild(levelDiv);
        });
        
        container.innerHTML = '';
        container.appendChild(orgChart);
    }

    // Construir hierarquia
    function buildHierarchy() {
        const hierarchy = [];
        const processed = new Set();
        const topLevel = organizationalChart.filter(p => !p.superiorId);
        
        if (topLevel.length > 0) {
            hierarchy.push(topLevel);
            topLevel.forEach(p => processed.add(p.id));
            
            while (processed.size < organizationalChart.length) {
                const currentLevel = [];
                organizationalChart.forEach(position => {
                    if (!processed.has(position.id) && 
                        position.superiorId && 
                        processed.has(position.superiorId)) {
                        currentLevel.push(position);
                        processed.add(position.id);
                    }
                });
                
                if (currentLevel.length > 0) {
                    hierarchy.push(currentLevel);
                } else {
                    break;
                }
            }
        }
        
        return hierarchy;
    }

    // Criar nó de posição
    function createPositionNode(position) {
        const nodeDiv = document.createElement('div');
        nodeDiv.className = `org-node ${position.level}`;
        nodeDiv.setAttribute('data-position-id', position.id);
        
        nodeDiv.innerHTML = `
            <div class="node-avatar">
                <i class="fas ${position.icon}"></i>
            </div>
            <div class="node-info">
                <h4>${position.name}</h4>
                <div class="position-title">${position.title}</div>
                ${position.department ? `<div class="position-department">${position.department}</div>` : ''}
            </div>
            <div class="node-actions">
                <button class="node-action-btn add-child" onclick="openAddPositionModal('${position.id}')" title="Adicionar Subordinado">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="node-action-btn edit" onclick="editPosition('${position.id}')" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="node-action-btn delete" onclick="deletePosition('${position.id}')" title="Excluir">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        nodeDiv.addEventListener('click', (e) => {
            if (!e.target.closest('.node-actions')) {
                showPositionDetails(position.id);
            }
        });
        
        return nodeDiv;
    }

    // Editar posição
    function editPosition(positionId) {
        const position = organizationalChart.find(p => p.id === positionId);
        if (!position) return;
        
        currentEditingPosition = positionId;
        document.getElementById('positionModalTitle').textContent = 'Editar Cargo';
        document.getElementById('positionName').value = position.name;
        document.getElementById('positionTitle').value = position.title;
        document.getElementById('positionDepartment').value = position.department || '';
        document.getElementById('positionEmail').value = position.email || '';
        document.getElementById('positionPhone').value = position.phone || '';
        document.getElementById('positionLevel').value = position.level;
        document.getElementById('positionIcon').value = position.icon;
        
        populateSuperiorDropdown(positionId);
        document.getElementById('positionSuperior').value = position.superiorId || '';
        document.getElementById('positionModal').style.display = 'block';
    }

    // Excluir posição
    function deletePosition(positionId) {
        const position = organizationalChart.find(p => p.id === positionId);
        if (!position) return;
        
        const hasSubordinates = organizationalChart.some(p => p.superiorId === positionId);
        let confirmMessage = `Tem certeza que deseja excluir o cargo "${position.name} - ${position.title}"?`;
        if (hasSubordinates) {
            confirmMessage += '\n\nATENÇÃO: Este cargo tem subordinados. Eles ficarão sem superior.';
        }
        
        if (confirm(confirmMessage)) {
            organizationalChart = organizationalChart.filter(p => p.id !== positionId);
            organizationalChart.forEach(p => {
                if (p.superiorId === positionId) {
                    p.superiorId = null;
                }
            });
            
            localStorage.setItem('organizationalChart', JSON.stringify(organizationalChart));
            renderOrganogram();
            showAdminNotification('Cargo excluído com sucesso!', 'success');
        }
    }

    // Mostrar detalhes da posição
    function showPositionDetails(positionId) {
        const position = organizationalChart.find(p => p.id === positionId);
        if (!position) return;
        
        const superior = position.superiorId ? 
            organizationalChart.find(p => p.id === position.superiorId) : null;
        const subordinates = organizationalChart.filter(p => p.superiorId === positionId);
        
        const content = document.getElementById('positionDetailsContent');
        if (!content) return;
        
        content.innerHTML = `
            <div class="position-details">
                <div class="position-details-avatar">
                    <i class="fas ${position.icon}"></i>
                </div>
                <div class="position-details-info">
                    <h4>${position.name}</h4>
                    <div class="position-title">${position.title}</div>
                    ${position.department ? `<p><strong>Departamento:</strong> ${position.department}</p>` : ''}
                    ${superior ? `<p><strong>Superior:</strong> ${superior.name} - ${superior.title}</p>` : '<p><strong>Posição:</strong> Cargo mais alto</p>'}
                    ${subordinates.length > 0 ? `<p><strong>Subordinados:</strong> ${subordinates.length}</p>` : ''}
                </div>
            </div>
            
            ${(position.email || position.phone) ? `
            <div class="position-contact">
                ${position.email ? `
                <div class="contact-item">
                    <i class="fas fa-envelope"></i>
                    <span>${position.email}</span>
                </div>
                ` : ''}
                ${position.phone ? `
                <div class="contact-item">
                    <i class="fas fa-phone"></i>
                    <span>${position.phone}</span>
                </div>
                ` : ''}
            </div>
            ` : ''}
            
            ${subordinates.length > 0 ? `
            <div style="margin-top: 1.5rem;">
                <h5>Subordinados:</h5>
                <div style="display: grid; gap: 0.5rem; margin-top: 0.8rem;">
                    ${subordinates.map(sub => `
                        <div class="contact-item" style="cursor: pointer;" onclick="showPositionDetails('${sub.id}'); closePositionDetailsModal();">
                            <i class="fas ${sub.icon}"></i>
                            <span>${sub.name} - ${sub.title}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            <div class="position-actions">
                <button class="btn btn-secondary" onclick="closePositionDetailsModal()">Fechar</button>
                <button class="btn btn-primary" onclick="editPosition('${position.id}'); closePositionDetailsModal();">
                    <i class="fas fa-edit"></i> Editar
                </button>
            </div>
        `;
        
        document.getElementById('positionDetailsModal').style.display = 'block';
    }

    // Fechar modal de detalhes
    function closePositionDetailsModal() {
        const modal = document.getElementById('positionDetailsModal');
        if (modal) modal.style.display = 'none';
    }

    // Toggle linhas de conexão
    function toggleConnectionLines() {
        const showLines = document.getElementById('showConnectionLines');
        if (!showLines) return;
        
        if (showLines.checked) {
            addConnectionLines();
        } else {
            removeConnectionLines();
        }
    }

    // Adicionar linhas de conexão
    function addConnectionLines() {
        removeConnectionLines();
    }

    // Remover linhas de conexão
    function removeConnectionLines() {
        document.querySelectorAll('.connection-line').forEach(line => line.remove());
    }

    // Resetar organograma
    function resetOrganogram() {
        if (confirm('Tem certeza que deseja resetar todo o organograma? Esta ação não pode ser desfeita.')) {
            organizationalChart = [];
            localStorage.removeItem('organizationalChart');
            showEmptyOrganogram();
            showAdminNotification('Organograma resetado com sucesso!', 'success');
        }
    }

    // Gerar ID único
    function generateId() {
        return 'pos_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    </script>
</body>
</html> 